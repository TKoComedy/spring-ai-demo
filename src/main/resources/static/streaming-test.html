<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring AI Demo - 流式输出测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .output {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
            min-height: 200px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .chunk {
            display: inline;
        }
        .error {
            color: #dc3545;
        }
        .success {
            color: #28a745;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #e9ecef;
            border: none;
            cursor: pointer;
            margin-right: 5px;
        }
        .tab.active {
            background-color: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spring AI Demo - 流式输出测试</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('chat')">流式聊天</button>
            <button class="tab" onclick="showTab('code')">流式代码生成</button>
            <button class="tab" onclick="showTab('summarize')">流式文档摘要</button>
            <button class="tab" onclick="showTab('image')">图像生成</button>
        </div>
        
        <!-- 流式聊天 -->
        <div id="chat" class="tab-content active">
            <div class="input-group">
                <label for="chatMessage">输入消息:</label>
                <textarea id="chatMessage" placeholder="请输入你的问题...">你好，请介绍一下自己</textarea>
            </div>
            <button onclick="startStreamingChat()">开始流式聊天</button>
            <div id="chatOutput" class="output"></div>
        </div>
        
        <!-- 流式代码生成 -->
        <div id="code" class="tab-content">
            <div class="input-group">
                <label for="codeRequirement">需求描述:</label>
                <textarea id="codeRequirement" placeholder="请描述你想要实现的代码功能...">实现一个简单的计算器</textarea>
            </div>
            <div class="input-group">
                <label for="codeLanguage">编程语言:</label>
                <select id="codeLanguage">
                    <option value="Java">Java</option>
                    <option value="Python">Python</option>
                    <option value="JavaScript">JavaScript</option>
                    <option value="C++">C++</option>
                </select>
            </div>
            <button onclick="startStreamingCode()">开始流式代码生成</button>
            <div id="codeOutput" class="output"></div>
        </div>
        
        <!-- 流式文档摘要 -->
        <div id="summarize" class="tab-content">
            <div class="input-group">
                <label for="summarizeContent">文档内容:</label>
                <textarea id="summarizeContent" placeholder="请输入要摘要的文档内容...">人工智能（Artificial Intelligence，AI）是计算机科学的一个分支，它企图了解智能的实质，并生产出一种新的能以人类智能相似的方式做出反应的智能机器。该领域的研究包括机器人、语言识别、图像识别、自然语言处理和专家系统等。人工智能从诞生以来，理论和技术日益成熟，应用领域也不断扩大，可以设想，未来人工智能带来的科技产品，将会是人类智慧的"容器"。人工智能可以对人的意识、思维的信息过程的模拟。人工智能不是人的智能，但能像人那样思考、也可能超过人的智能。</textarea>
            </div>
            <button onclick="startStreamingSummarize()">开始流式摘要</button>
            <div id="summarizeOutput" class="output"></div>
        </div>
        
        <!-- 图像生成 -->
        <div id="image" class="tab-content">
            <div class="input-group">
                <label for="imagePrompt">图像描述:</label>
                <textarea id="imagePrompt" placeholder="请描述你想要生成的图像...">一只可爱的小猫在花园里玩耍</textarea>
            </div>
            <button onclick="generateImage()">生成图像</button>
            <div id="imageOutput" class="output"></div>
        </div>
    </div>

    <script>
        function showTab(tabName) {
            // 隐藏所有标签页内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // 移除所有标签的active类
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 显示选中的标签页
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function startStreamingChat() {
            const message = document.getElementById('chatMessage').value;
            const output = document.getElementById('chatOutput');
            
            if (!message.trim()) {
                alert('请输入消息');
                return;
            }
            
            output.textContent = '正在连接...\n';
            
            const eventSource = new EventSource(`/api/streaming/chat`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            });
            
            // 使用fetch进行POST请求
            fetch('/api/streaming/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                output.textContent = '';
                
                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                try {
                                    const json = JSON.parse(data);
                                    if (json.type === 'chunk') {
                                        output.textContent += json.content;
                                    } else if (json.type === 'error') {
                                        output.textContent += '\n错误: ' + json.message;
                                    }
                                } catch (e) {
                                    // 忽略解析错误
                                }
                            }
                        });
                        
                        readStream();
                    });
                }
                
                readStream();
            })
            .catch(error => {
                output.textContent += '\n连接错误: ' + error.message;
            });
        }
        
        function startStreamingCode() {
            const requirement = document.getElementById('codeRequirement').value;
            const language = document.getElementById('codeLanguage').value;
            const output = document.getElementById('codeOutput');
            
            if (!requirement.trim()) {
                alert('请输入需求描述');
                return;
            }
            
            output.textContent = '正在生成代码...\n';
            
            fetch('/api/streaming/generate-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    requirement: requirement,
                    language: language
                })
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                output.textContent = '';
                
                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                try {
                                    const json = JSON.parse(data);
                                    if (json.type === 'chunk') {
                                        output.textContent += json.content;
                                    } else if (json.type === 'error') {
                                        output.textContent += '\n错误: ' + json.message;
                                    }
                                } catch (e) {
                                    // 忽略解析错误
                                }
                            }
                        });
                        
                        readStream();
                    });
                }
                
                readStream();
            })
            .catch(error => {
                output.textContent += '\n连接错误: ' + error.message;
            });
        }
        
        function startStreamingSummarize() {
            const content = document.getElementById('summarizeContent').value;
            const output = document.getElementById('summarizeOutput');
            
            if (!content.trim()) {
                alert('请输入文档内容');
                return;
            }
            
            output.textContent = '正在生成摘要...\n';
            
            fetch('/api/streaming/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content: content })
            })
            .then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                output.textContent = '';
                
                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        lines.forEach(line => {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                try {
                                    const json = JSON.parse(data);
                                    if (json.type === 'chunk') {
                                        output.textContent += json.content;
                                    } else if (json.type === 'error') {
                                        output.textContent += '\n错误: ' + json.message;
                                    }
                                } catch (e) {
                                    // 忽略解析错误
                                }
                            }
                        });
                        
                        readStream();
                    });
                }
                
                readStream();
            })
            .catch(error => {
                output.textContent += '\n连接错误: ' + error.message;
            });
        }
        
        function generateImage() {
            const prompt = document.getElementById('imagePrompt').value;
            const output = document.getElementById('imageOutput');
            
            if (!prompt.trim()) {
                alert('请输入图像描述');
                return;
            }
            
            output.textContent = '正在生成图像...\n';
            
            fetch('/api/advanced-ai/generate-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt: prompt })
            })
            .then(response => response.json())
            .then(data => {
                output.textContent = '图像生成结果:\n';
                output.textContent += '提示词: ' + data.prompt + '\n';
                output.textContent += '图像URL: ' + data.imageUrl + '\n';
                
                // 如果返回的是URL，尝试显示图像
                if (data.imageUrl && data.imageUrl.startsWith('http')) {
                    const img = document.createElement('img');
                    img.src = data.imageUrl;
                    img.style.maxWidth = '100%';
                    img.style.marginTop = '10px';
                    output.appendChild(img);
                }
            })
            .catch(error => {
                output.textContent += '\n生成失败: ' + error.message;
            });
        }
    </script>
</body>
</html> 